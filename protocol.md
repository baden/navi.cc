# Наработки по протоколу

## Используемые термины.

`неточное событие` - Событие, которое не требует точной привязки ко времени и обязательной доставки на сервер. К таким событиям относятся:

- Включение/выключение прибора;
- Выполнение (некритичных) SMS-команд;
- Обновление внутренного программного обеспечения прибора;
- и т.д.

`точное событие` - Событие, которое привязано к точному значению времени и обязано попасть на сервер.
Такие события как правило отмечаются на треке или в отчетах в виде специальных значков. Также на такие события могут быть назначены SMS и email-уведомления. Пример таких событий:

- Обесточивание прибора;
- Вскрытие корпуса прибора;
- Нажатие тревожной кнопки;
- Слив топлива;

## Обмен прибора с сервером.

С целью экономии трафика большинство передаваемых данных представлены в бинарном формате.
Основные используемые данные:

`Дата/время` - Представляет собой целое 32битное значение, равное кол-ву секунд, прошедших с 1.01.1970 00:00:00. Пример реализации такого преобразования приведен например [тут](http://ww1.microchip.com/downloads/en/AppNotes/01412A.pdf)

`Широта/Долгота` - Представляет собой целое 32битное значение со знаком, где единица равна 1/10000 минуте. Например:

    x = (Гадусы*60 + минуты)*10000 + доли минут. 48°50.1234’ = 29301234

Для полушарий S и W значения соответственно отрицательные.

`Скорость` - Представляет собой целое 16битное значение, где единица равна 1/100 узла (0,01852 км/ч).

`Направление` - Представляет собой целое 8бит значение (0..179), где единица равна 2 градуса.

`Строки` - Если используется протокол не в обертке HTTP, то строки передаются с завершающим нулем.

## Протокол.

Первое поколение комплекса было построено на Google App Engine. Выбор платформы определил протокол передачи данных, это мог быть только HTTP. Данный протокол вносил значительные накладные расходы. Что могло значительно увеличить расход трафика при передаче небольших порций данных (например при передаче одной точки). Протокол на HTTP описан в отдельном документе, можно обратиться к разработчикам чтобы получить его. В этом документе предполагается что используется выделенный сервер и протокол обмена прибора с сервером разрабатывается на сыром TCP/IP.

### Общий формат пакета данных.

Любой пакет начинается с двух символов `0xFF` `0xFF`. Следующий байт определяет тип пакета:

| Значение | Описание |
|:---:|:---|
| 1 | *Неточное событие из списка.* Текст данных событий фиксирован и определяется значением следующих двух байт (16битное целое значение). Перечень событий приведен ниже и в процессе развития комплекса будет пополняться.
| 2 | *Неточное событие с текстом от прибора.* Используется если прибору необходимо отправить синтезированных текст сообщения, например прислать версию прошивки прибора. Как и в случае неточного события из списка следующие два байта определяют код события. Это необходимо для возможности фильтрации на сервере событие по типу, добавления дополнительной реакции на события и т.д. Список типов событий приведен ниже. Далее следует строка сообщения, завершенная нулем (\0x00).
| 3 | *Пакет гео-данных*.

### Неточное событие из списка.

| Значение | Описание |
|:---:|:---|
| 1 | Прибор включен.
| 2 | Прибор выключен.
| 3 | Отключение GPS для экономии энергии.

### Неточное событие с текстом.

1..500 повторяют значения из предыдущего раздела.

| Значение | Описание |
|:---:|:---|
| 501 | Версия прибора. |
| 502 | Выполнена SMS-команда. |

### Пакет гео-данных.

Основная передаваемая прибором информация - это точки трека и "точные события". В общем виде тело пакета имеет следующий вид:

    HIDDDDDHIDDDDDHIDDDDEECC

где:
H - Заголовок записи, равный \0xFF
I - Идентификатор (тип) записи
DDD - тело записи
EE - маркер конца пакета, равный \0xFF\0xFE
СС - циклическая контрольная сумма. CRC16-CCITT: Poly=0x1021, Init=0, Revert=false, XorOut=0x0000, Check: CRC("123456789")=0x31C3

Типы записей (I):

`0xF1` - Минимальные GPS-данные. (24 байта)

| Размер | Описание |
|:---:|:---|
| 32 бит | Дата/время
| 32 бит | Широта
| 32 бит | Долгота
| 16 бит | Скорость
| 8 бит | Направление
| 8 бит | Спутники (обычно от 3 до 12)
| 16 бит | Напряжение основного аккумулятора (ед = 1/100 В)
| 16 бит | Напряжение резервного аккумулятора (ед = 1/100 В)
| 8 бит | Тип точки (причина фиксации точки)
| 16 бит | Флаги (бит0 - Дата/время содержит неточное смещение, )
| 8 бит | Контрольная сумма записи (простая сумма всех значений).

`0xF2` - Расширенные GPS-данные.

    В разработке

`0xF5` - Точное событие ()

| Размер | Описание |
|:---:|:---|
| 32 бит | Дата/время
| 32 бит | Широта
| 32 бит | Долгота
| 16 бит | Идентификатор события
| 16 бит | Параметр события
| 32 бит | Дополнительные параметры события

Точное событие может быть зафиксировано только если в приборе есть валидные данные от GPS хотябы о времени. Если данных о координатах нет, то устанавливается Долгота и широта равные 0x7F7F7F7F (такой координаты не бывает).

Перечерь идентификаторов точного события:

| Значение | Описание |
|:---:|:---|
| 1 | Отключение внешнего питания.
| 2 | Включение внешнего питания.
| 3 | Превышение допустимых пределов рабочего напряжения питания. В дополнительных параметрах указано напряжение в вольтах.
| 4 | Пропадание сигнала GPS.
| 5 | Появление сигнала GPS.
| 6 | Пропадание GSM/GPRS.
| 7 | Восстановление GSM/GPRS.
| 8 | Нажатие тревожной кнопки SOS.
| 9 | Повреждение шлейфа.
| 10 | Восстановление шлейфа.
| 11 | Вскрытие корпуса.
| 12 | Закрывание корпуса.
| 13 | Слив топлива. В дополнительных параметрах могут быть указаны значения в литрах.
| 14 | Заправка.  В дополнительных параметрах могут быть указаны значения в литрах.

Список будет пополняться.
